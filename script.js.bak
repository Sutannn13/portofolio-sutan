/*
================================================================================
| SCRIPT.JS - PORTOFOLIO SUTAN ARLIE JOHAN - FIXED & ENHANCED v3.0             |
================================================================================
*/

document.addEventListener('DOMContentLoaded', () => {

    /* 1. STATE & CONSTANTS */
    const state = {
        blogCurrentPage: 1,
        blogPostsPerPage: 3,
        testimonialCurrentIndex: 0,
        testimonialInterval: null,
        isTouchDevice: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
    };

    const selectors = {
        loader: '#loader',
        progressBarFill: '.progress-bar-fill',
        progressPercentage: '.progress-percentage',
        header: '#main-header',
        navLinks: '.nav-link',
        sections: 'section[id]',
        themeToggle: '#theme-toggle',
        hamburger: '#hamburger-button',
        navMenu: '.nav-menu',
        animateOnScroll: '.animate-on-scroll',
        statNumbers: '.stat-number',
        progressBars: '.progress-bar',
        projectCards: '.project-card', // Ini juga dipakai untuk kartu sertifikat
        projectFilters: '.project-filters',
        filterBtns: '.filter-btn',
        projectModal: '#project-modal',
        modalCloseBtn: '#modal-close-btn',
        modalBody: '#modal-body',
        testimonialCarousel: '#testimonial-carousel',
        testimonialSlides: '.testimonial-slide',
        testimonialIndicators: '#testimonial-indicators',
        testimonialPrevBtn: '#testimonial-prev-btn',
        testimonialNextBtn: '#testimonial-next-btn',
        blogPostsContainer: '#blog-posts-container',
        blogPagination: '#blog-pagination',
        contactForm: '#contact-form',
        formStatus: '#form-status',
        copyrightYear: '#copyright-year',
        scrollToTopBtn: '#scroll-to-top',
        heroSection: '.hero-section',
        heroImageWrapper: '.hero-image-wrapper',
        typingEffect: '#typing-effect',
        customCursor: '#custom-cursor',
        magneticButtons: '[data-magnetic]',
        hoverableElements: 'a, button, .project-card, .indicator-dot, .tool-badge, .cert-card',
        revealTextElements: '.reveal-text',
        fadeOnScrollText: '.fade-on-scroll-text',
        spotlight: '#spotlight',
        staggerContainers: '.stagger-container',
        aboutImageWrapper: '.about-image-wrapper',
        timeline: '.timeline',
        timelineProgress: '.timeline-progress',
        timelineScrollDot: '.timeline-scroll-dot',
        timelineItems: '.timeline-item',
    };

    const dom = {};
    for (const key in selectors) {
        const elements = document.querySelectorAll(selectors[key]);
        if (elements.length > 0) {
            dom[key] = elements.length === 1 ? elements[0] : Array.from(elements);
        }
    }

    /* 2. DATA DATABASE (PROJECTS & CERTIFICATES) */

    // Data Proyek (Seperti sebelumnya)
    const projectData = {
        'Trash Point (HKI)': {
            type: 'project',
            title: 'Trash Point (Proyek Unggulan & Peraih HKI)',
            image: 'https://images.unsplash.com/photo-1593113598332-cd288d649433?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1200',
            description: 'Trash Point adalah platform inovatif manajemen sampah berbasis web dan IoT. Menciptakan ekosistem efisien, transparan, dan insentif.',
            purpose: 'Mengurangi penumpukan sampah di TPA dan memberikan nilai ekonomis.',
            tech: ['React.js', 'Node.js', 'PostgreSQL', 'MQTT', 'PWA'],
            result: 'Prototipe fungsional dengan HKI resmi.',
            liveLink: '#',
            repoLink: '#',
        },
        'E-Learning UBSI': {
            type: 'project',
            title: 'Platform E-Learning UBSI',
            image: 'https://images.unsplash.com/photo-1516321497487-e288fb19713f?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1200',
            description: 'Platform pembelajaran online untuk kebutuhan mahasiswa dan dosen UBSI.',
            purpose: 'Efektivitas belajar mengajar digital.',
            tech: ['PHP (CodeIgniter)', 'JS', 'MySQL', 'Bootstrap'],
            result: 'Implementasi sukses untuk beberapa mata kuliah.',
            liveLink: '#',
            repoLink: '#',
        },
        'Dashboard Analitik': {
            type: 'project',
            title: 'Dashboard Analitik Penjualan',
            image: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1200',
            description: 'Visualisasi data penjualan kompleks dalam bentuk dashboard interaktif.',
            purpose: 'Membantu keputusan bisnis tim manajemen.',
            tech: ['Vanilla JS', 'Chart.js', 'REST API'],
            result: 'Dashboard cepat dan responsif untuk big data.',
            liveLink: '#',
            repoLink: '#',
        },
        'Kuliner Depok': {
            type: 'project',
            title: 'Aplikasi PWA Resep Kuliner Depok',
            image: 'https://images.unsplash.com/photo-1583508915901-b5f84c1dcde1?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1200',
            description: 'Direktori resep masakan khas Depok berbasis PWA (Offline First).',
            purpose: 'Promosi kekayaan kuliner lokal.',
            tech: ['PWA', 'Service Worker', 'Vanilla JS'],
            result: 'Aplikasi ringan layaknya native app.',
            liveLink: '#',
            repoLink: '#',
        },

        // --- DATA SERTIFIKAT BARU (Diambil dari PDF Kamu) ---
        'Cisco Certification': {
            type: 'certificate',
            title: 'Introduction to Cybersecurity',
            image: 'Sertifikat-Cisco.pdf', // PDF akan di-embed atau dijadikan link
            isPdf: true,
            issuer: 'Cisco Networking Academy',
            date: '03 November 2025',
            description: 'Sertifikasi kompetensi dasar keamanan siber yang mencakup pengenalan ancaman siber, perlindungan data pribadi, dan keamanan infrastruktur jaringan perusahaan. Diberikan langsung oleh Cisco Networking Academy.',
            fileUrl: 'Sertifikat-Cisco.pdf'
        },
        'IT Bootcamp Nasional': {
            type: 'certificate',
            title: 'Juara 2 - IT Bootcamp "Software Development"',
            image: 'Sertifikat-Bootcamp.pdf',
            isPdf: true,
            issuer: 'Universitas Bina Sarana Informatika',
            date: '25 Juni 2025',
            description: 'Penghargaan Juara 2 dalam kompetisi IT Bootcamp "Software Development For Industry". Kompetisi ini melibatkan Workshop, Proyek Pengembangan (7 Jam), dan Presentasi Akhir. Membuktikan kemampuan coding di bawah tekanan waktu.',
            fileUrl: 'Sertifikat-Bootcamp.pdf'
        },
        'Sertifikat HKI Trash Point': { // Nama disesuaikan dengan HTML nanti
            type: 'certificate',
            title: 'Surat Pencatatan Ciptaan (HKI)',
            image: 'Sertifikat-Bootcamp-Sutan-Arlie.pdf', // Asumsi nama file HKI
            isPdf: true,
            issuer: 'Kementerian Hukum dan HAM RI',
            date: '06 Agustus 2025',
            description: 'Surat Pencatatan Ciptaan (Hak Kekayaan Intelektual) resmi untuk Program Komputer "Aplikasi Edukasi Dan Pengelolaan Sampah Berbasis Web (Trash Point)". Bukti legalitas dan orisinalitas karya inovasi.',
            fileUrl: 'Sertifikat-Bootcamp-Sutan-Arlie.pdf'
        },

    };

    const blogPosts = [
        // ... (Data blog biarkan sama seperti sebelumnya) ...
        {
            id: 1,
            title: 'Memahami Asynchronous JavaScript',
            category: 'Teknologi',
            date: '10 Agustus 2025',
            excerpt: 'JavaScript modern sangat bergantung pada operasi asynchronous. Mari kita bedah perbedaan Promise vs Async/Await.',
            image: 'https://images.unsplash.com/photo-1627398242454-45a1465c2479?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600'
        },
        // ... dst (untuk menyingkat kode di sini, pakai data lama mu)
    ];

    /* 3. INITIALIZATION */
    const init = () => {
        prepareTextReveal();
        setupEventListeners();
        initTheme();
        initLoader();
        initScrollSpy();
        initAnimations();
        initBlog();
        initTestimonialCarousel();
        initInteractiveEffects(); // Efek kursor di sini
        updateCopyrightYear();
        prepareTextFadeWords(); // PREPARE WORD BY WORD
        handleTextFadeOnScroll();
        handleTimelineScrollAnimation();
    };

    // --- DATA SERTIFIKAT BARU (Diambil dari PDF Kamu) ---
    const certificateData = {
        "Introduction to Cybersecurity": {
            type: "certificate",
            title: "Introduction to Cybersecurity",
            image: "Sertifikat-Cisco.pdf",
            isPdf: true,
            issuer: "Cisco Networking Academy",
            date: "03 November 2025",
            description:
                "Sertifikasi kompetensi dasar keamanan siber yang mencakup pengenalan ancaman siber, perlindungan data pribadi, dan keamanan infrastruktur jaringan perusahaan. Diberikan langsung oleh Cisco Networking Academy.",
            fileUrl: "Sertifikat-Cisco.pdf",
        },
        "Juara 2 - IT Bootcamp Software Development": {
            type: "certificate",
            title: "Juara 2 - IT Bootcamp Software Development",
            image: "Sertifikat-Bootcamp.pdf",
            isPdf: true,
            issuer: "Universitas Bina Sarana Informatika",
            date: "25 Juni 2025",
            description:
                "Penghargaan Juara 2 dalam kompetisi IT Bootcamp Software Development For Industry. Kompetisi ini melibatkan Workshop, Proyek Pengembangan 7 Jam, dan Presentasi Akhir. Membuktikan kemampuan coding di bawah tekanan waktu.",
            fileUrl: "Sertifikat-Bootcamp.pdf",
        },
        "Surat Pencatatan Ciptaan HKI": {
            type: "certificate",
            title: "Surat Pencatatan Ciptaan HKI",
            image: "Sertifikat-Bootcamp-Sutan-Arlie.pdf",
            isPdf: true,
            issuer: "Kementerian Hukum dan HAM RI",
            date: "06 Agustus 2025",
            description:
                "Surat Pencatatan Ciptaan Hak Kekayaan Intelektual resmi untuk Program Komputer Aplikasi Edukasi Dan Pengelolaan Sampah Berbasis Web â€œTrash Pointâ€. Bukti legalitas dan orisinalitas karya inovasi.",
            fileUrl: "Sertifikat-Bootcamp-Sutan-Arlie.pdf",
        },
        "MikroTik Certified Network Associate (MTCNA)": {
            type: "certificate",
            title: "MikroTik Certified Network Associate (MTCNA)",
            image: "Sutan-Arlie-MTCNA.pdf",
            isPdf: true,
            issuer: "MikroTik",
            date: "17 Januari 2026",
            description:
                "Sertifikasi resmi MTCNA yang mencakup konfigurasi dasar RouterOS, manajemen bandwidth, firewall, dan routing pada jaringan kecil hingga menengah.",
            fileUrl: "Sutan-Arlie-MTCNA.pdf",
        },
    };


    /* 4. EVENT LISTENERS */
    const setupEventListeners = () => {
        if (dom.themeToggle) dom.themeToggle.addEventListener('click', toggleTheme);
        if (dom.hamburger) dom.hamburger.addEventListener('click', toggleMobileMenu);

        // Passive scroll listener for better performance
        window.addEventListener('scroll', throttle(handleScroll, 10), { passive: true });

        // --- FIX KURSOR: Pindahkan listener mousemove ke level window global ---
        // Tidak peduli touch device atau bukan, kita dengarkan mousemove untuk jaga-jaga (hybrid)
        window.addEventListener('mousemove', handleGlobalMouseMove);

        if (dom.navLinks) {
            dom.navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    const href = link.getAttribute('href');
                    // ðŸ”§ FIX: Hanya smooth scroll jika anchor (#), bukan page lain
                    if (href.startsWith('#')) {
                        smoothScroll(e);
                    } else if (href.includes('.html')) {
                        // Biarkan browser navigate ke page lain (sertifikat.html, dll)
                        return;
                    }
                    if (dom.navMenu.classList.contains('active')) {
                        toggleMobileMenu();
                    }
                });
            });
        }
        if (dom.projectFilters) {
            dom.projectFilters.addEventListener("click", handleProjectFilter);
        }

        // Handler untuk Project Cards DAN Certificate Cards
        const allCards = document.querySelectorAll(".project-card, .cert-card");

        if (allCards.length) {
            allCards.forEach(card => {
                if (!state.isTouchDevice) {
                    // card.addEventListener("mousemove", handleCardTilt); // DISABLED OLD TILT
                    // card.addEventListener("mouseleave", resetCardTilt); // DISABLED OLD TILT
                }

                // Klik di area kartu apa pun buka modal (HANYA untuk project)
                card.addEventListener("click", e => {
                    // Kalau ini kartu sertifikat, biarkan tombol yang handle
                    if (card.classList.contains("cert-card")) return;

                    e.preventDefault();
                    e.stopPropagation();
                    openUniversalModal(card);
                });


                // Tombol di dalam kartu sertifikat
                const viewBtn = card.querySelector(".cert-open-btn")
                const downloadBtn = card.querySelector(".cert-download-btn");

                if (viewBtn) {
                    viewBtn.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        openUniversalModal(card);
                    });
                }


                if (downloadBtn) {
                    downloadBtn.addEventListener("click", e => {
                        e.preventDefault();
                        e.stopPropagation();

                        const title = card.querySelector("h3")?.textContent.trim();
                        const cert = certificateData[title];
                        if (!cert) return;

                        const a = document.createElement("a");
                        a.href = cert.fileUrl;
                        a.download = `${title} - sertifikat.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    });
                }
            });
        }




        if (dom.aboutImageWrapper && !state.isTouchDevice) {
            dom.aboutImageWrapper.addEventListener('mousemove', handleAboutImageTilt);
            dom.aboutImageWrapper.addEventListener('mouseleave', resetAboutImageTilt);
        }

        // ID Card Physics Interaction (Lanyard Effect)
        initIdCardPhysics();

        if (dom.projectModal) dom.projectModal.addEventListener('click', handleModalClick);
        if (dom.modalCloseBtn) dom.modalCloseBtn.addEventListener('click', closeProjectModal);
        document.addEventListener('keydown', handleKeyboardInput);

        if (dom.contactForm) {
            dom.contactForm.addEventListener('submit', handleFormSubmit);
            const formInputs = dom.contactForm.querySelectorAll('input, textarea');
            formInputs.forEach(input => {
                input.addEventListener('blur', (e) => validateField(e.target));
                input.addEventListener('input', (e) => validateField(e.target));
            });
        }

        // ... (Testimonial buttons logic sama seperti sebelumnya) ...
        if (dom.testimonialPrevBtn && dom.testimonialNextBtn) {
            dom.testimonialPrevBtn.addEventListener('click', () => { prevTestimonialSlide(); resetTestimonialInterval(); });
            dom.testimonialNextBtn.addEventListener('click', () => { nextTestimonialSlide(); resetTestimonialInterval(); });
        }

        if (dom.scrollToTopBtn) {
            dom.scrollToTopBtn.addEventListener('click', (e) => {
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    };

    /* 5. HANDLER FUNCTIONS (Revised) */

    // --- FIX KURSOR & SPOTLIGHT DIGABUNG ---
    const handleGlobalMouseMove = (e) => {
        // Update Spotlight
        requestAnimationFrame(() => {
            if (dom.spotlight) {
                dom.spotlight.style.left = `${e.clientX}px`;
                dom.spotlight.style.top = `${e.clientY}px`;
            }
            // Update Custom Cursor
            if (dom.customCursor) {
                const cursorDot = dom.customCursor.querySelector('#cursor-dot');
                const cursorCircle = dom.customCursor.querySelector('#cursor-circle');
                if (cursorDot && cursorCircle) {
                    cursorDot.style.left = `${e.clientX}px`;
                    cursorDot.style.top = `${e.clientY}px`;
                    cursorCircle.style.left = `${e.clientX}px`;
                    cursorCircle.style.top = `${e.clientY}px`;
                }
            }
        });
    };

    const handleScroll = () => {
        if (dom.header) dom.header.classList.toggle('scrolled', window.scrollY > 50);
        if (dom.scrollToTopBtn) dom.scrollToTopBtn.classList.toggle('show', window.scrollY > 300);
        initScrollSpy();
        handleParallax();
        handleTextFadeOnScroll();
        handleScrollDirection();
        handleTimelineScrollAnimation();
    };

    // --- NEW: Prepare Paragraphs by splitting into words ---
    const prepareTextFadeWords = () => {
        if (!dom.fadeOnScrollText) return;
        dom.fadeOnScrollText.forEach(paragraph => {
            const text = paragraph.innerText;
            const words = text.split(' ');
            paragraph.innerHTML = ''; // Clear content
            words.forEach(word => {
                const span = document.createElement('span');
                span.textContent = word + ' '; // Add space back
                paragraph.appendChild(span);
            });
        });
    };

    // --- NEW: Handle Word-by-Word Reveal on Scroll ---
    const handleTextFadeOnScroll = () => {
        if (!dom.fadeOnScrollText) return;

        dom.fadeOnScrollText.forEach(paragraph => {
            const rect = paragraph.getBoundingClientRect();
            const spans = paragraph.querySelectorAll('span');

            // Logika: Mulai highlight saat elemen masuk viewport (misal 80% dari bawah)
            // dan selesai highlight saat elemen berada di tengah atau atas.

            const windowHeight = window.innerHeight;
            // Kita ingin hitung progress 0% sampai 100%
            // 0% saat elemen baru masuk bottom (top = windowHeight)
            // 100% saat elemen hampir keluar top atau di posisi baca yang enak

            // Adjust nilai offset ini untuk rasa "smooth" yang diinginkan
            const startTrigger = windowHeight * 0.9;
            const endTrigger = windowHeight * 0.4;

            // Posisi relatif top elemen terhadap viewport
            const elementTop = rect.top;

            // Hitung progress (0.0 - 1.0)
            let progress = (startTrigger - elementTop) / (startTrigger - endTrigger);
            progress = Math.max(0, Math.min(1, progress)); // Clamp 0-1

            const totalWords = spans.length;
            const wordsToHighlight = Math.floor(progress * totalWords);

            spans.forEach((span, index) => {
                if (index < wordsToHighlight) {
                    span.classList.add('highlight');
                } else {
                    span.classList.remove('highlight');
                }
            });
        });
    };

    let _lastScrollY = window.pageYOffset || 0;
    const handleScrollDirection = () => {
        const currentY = window.pageYOffset || 0;
        const isDown = currentY > _lastScrollY;
        _lastScrollY = currentY;
        if (!dom.fadeOnScrollText) return;
        dom.fadeOnScrollText.forEach(el => {
            const rect = el.getBoundingClientRect();
            if (rect.top < window.innerHeight * 0.9 && rect.bottom > 0) {
                if (isDown) el.classList.add('is-bright');
                else el.classList.remove('is-bright');
            }
        });
    };

    const handleTimelineScrollAnimation = () => {
        if (!dom.timeline || !dom.timelineProgress || !dom.timelineScrollDot || !dom.timelineItems) return;
        const timelineRect = dom.timeline.getBoundingClientRect();
        const timelineHeight = dom.timeline.offsetHeight;
        const triggerPoint = window.innerHeight * 0.4;
        const distanceToTrigger = triggerPoint - timelineRect.top;
        const scrollProgress = Math.min(Math.max(0, distanceToTrigger), timelineHeight);
        const progressPercentage = (scrollProgress / timelineHeight) * 100;

        dom.timelineProgress.style.height = `${progressPercentage}%`;
        dom.timelineScrollDot.style.top = `${progressPercentage}%`;

        dom.timelineItems.forEach(item => {
            const itemCenterInTimeline = item.offsetTop + (item.offsetHeight / 2);
            if (scrollProgress >= itemCenterInTimeline) {
                item.classList.add('is-active');
            }
        });
    };

    /* 6. CORE FUNCTIONS */

    // ... (initTheme, initLoader sama seperti sebelumnya) ...
    const initTheme = () => {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    };
    const toggleTheme = () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    };
    const initLoader = () => {
        // 1. Kalau elemen loader tidak ada, jangan apa-apa
        if (!dom.loader) {
            document.body.classList.remove("loading");
            return;
        }

        // 2. Khusus halaman sertifikat, SKIP animasi loader biar tidak nyangkut
        const isCertificatePage = window.location.pathname.includes("sertifikat");
        if (isCertificatePage) {
            dom.loader.classList.add("fade-out");
            document.body.classList.remove("loading");
            return;
        }

        // 3. Halaman lain (landing) pakai animasi loader biasa
        let progress = 0;

        const updateUI = () => {
            if (dom.progressBarFill) {
                dom.progressBarFill.style.width = `${progress}%`;
            }
            if (dom.progressPercentage) {
                dom.progressPercentage.textContent = progress;
            }
        };

        const intervalId = setInterval(() => {
            progress += 5;
            updateUI();

            if (progress >= 100) {
                clearInterval(intervalId);
                dom.loader.classList.add("fade-out");
                document.body.classList.remove("loading");
            }
        }, 50);
    };


    const initScrollSpy = () => {
        // Logic scroll spy hanya jalan jika kita di halaman utama yang punya section
        if (!dom.sections || dom.sections.length === 0) return;
        const scrollY = window.pageYOffset;
        dom.sections.forEach(current => {
            const sectionHeight = current.offsetHeight;
            const sectionTop = current.offsetTop - 100;
            const sectionId = current.getAttribute('id');
            const navLink = document.querySelector(`.nav-menu a[href*=${sectionId}]`);
            if (navLink) {
                navLink.classList.toggle('active', scrollY > sectionTop && scrollY <= sectionTop + sectionHeight);
            }
        });
    };

    const toggleMobileMenu = () => {
        dom.hamburger.classList.toggle('active');
        dom.navMenu.classList.toggle('active');
        document.body.style.overflow = dom.navMenu.classList.contains('active') ? 'hidden' : '';
    };

    const smoothScroll = (e) => {
        e.preventDefault();
        const targetId = e.currentTarget.getAttribute('href');
        const targetElement = document.querySelector(targetId);
        if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };

    // Animation Init
    const initAnimations = () => {
        const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const el = entry.target;
                    if (el.classList.contains('animate-on-scroll') || el.classList.contains('cert-card')) {
                        el.classList.add('is-visible');
                    }
                    if (el.matches(selectors.statNumbers)) animateCounter(el);
                    if (el.matches(selectors.progressBars)) animateProgressBar(el);
                    if (el.matches(selectors.staggerContainers)) animateStaggeredChildren(el);
                    if (el.matches(selectors.revealTextElements)) el.classList.add('is-visible');
                    observer.unobserve(el);
                }
            });
        }, observerOptions);

        const elementsToObserve = [
            ...document.querySelectorAll(selectors.animateOnScroll),
            ...document.querySelectorAll('.cert-card'), // Tambahkan kartu sertifikat
            ...document.querySelectorAll(selectors.statNumbers),
            ...document.querySelectorAll(selectors.progressBars),
            ...document.querySelectorAll(selectors.staggerContainers),
            ...document.querySelectorAll(selectors.revealTextElements)
        ];
        elementsToObserve.forEach(el => el && observer.observe(el));
    };

    // ... (animateCounter, animateProgressBar, animateStaggeredChildren, prepareTextReveal sama seperti sebelumnya) ...
    const animateCounter = (element) => {
        const target = +element.getAttribute('data-target');
        const duration = 2000;
        let current = 0;
        const stepTime = Math.max(1, Math.floor(duration / target));
        const timer = setInterval(() => {
            current += 1;
            element.innerText = current;
            if (current >= target) { element.innerText = target; clearInterval(timer); }
        }, stepTime);
    };
    const animateProgressBar = (el) => { el.style.width = el.getAttribute('data-level') + '%'; };
    const animateStaggeredChildren = (container) => {
        const children = container.querySelectorAll('.stagger-item, .cert-card');
        children.forEach((child, index) => { setTimeout(() => { child.classList.add('is-visible'); }, index * 150); });
    };
    const prepareTextReveal = () => {
        if (!dom.revealTextElements) return;
        dom.revealTextElements.forEach(el => {
            const text = el.textContent.trim();
            el.innerHTML = '';
            text.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char === ' ' ? '\u00A0' : char;
                span.style.transitionDelay = `${index * 30}ms`;
                el.appendChild(span);
            });
        });
    };

    // Interactive Effects
    const handleParallax = () => {
        if (dom.heroSection) {
            const scrollY = window.pageYOffset;
            dom.heroSection.style.setProperty('--parallax-y', `${scrollY * 0.3}px`);
        }
    };
    const handleCardTilt = (e) => {
        const card = e.currentTarget;
        const { width, height, left, top } = card.getBoundingClientRect();
        const x = e.clientX - left, y = e.clientY - top;
        const rotateX = ((y - height / 2) / (height / 2)) * -10;
        const rotateY = ((x - width / 2) / (width / 2)) * 10;
        card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.05, 1.05, 1.05)`;
    };
    const resetCardTilt = (e) => { e.currentTarget.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)'; };

    // ... (handleAboutImageTilt, resetAboutImageTilt sama) ...
    const handleAboutImageTilt = (e) => {
        const wrapper = e.currentTarget;
        const image = wrapper.querySelector('.about-image');
        if (!image) return;
        const { width, height, left, top } = wrapper.getBoundingClientRect();
        const x = e.clientX - left, y = e.clientY - top;
        const intensity = 8;
        const rotateX = ((y - height / 2) / (height / 2)) * -intensity;
        const rotateY = ((x - width / 2) / (width / 2)) * intensity;
        image.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
    };
    const resetAboutImageTilt = (e) => {
        const wrapper = e.currentTarget;
        const image = wrapper.querySelector('.about-image');
        if (image) image.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
    };

    const initInteractiveEffects = () => {
        // Kita hanya init cursor hover effect classes, logic gerak sudah di global listener
        if (dom.customCursor) {
            document.querySelectorAll(selectors.hoverableElements).forEach(el => {
                el.addEventListener('mouseenter', () => dom.customCursor.classList.add('hovered'));
                el.addEventListener('mouseleave', () => dom.customCursor.classList.remove('hovered'));
            });
        }
        if (dom.magneticButtons) {
            dom.magneticButtons.forEach(btn => {
                btn.addEventListener('mousemove', function (e) {
                    const { left, top, width, height } = this.getBoundingClientRect();
                    const x = (e.clientX - left - width / 2) * 0.2;
                    const y = (e.clientY - top - height / 2) * 0.3;
                    this.style.transform = `translate(${x}px, ${y}px)`;
                });
                btn.addEventListener('mouseleave', function () { this.style.transform = 'translate(0,0)'; });
            });
        }
        initTypingEffect();
    };

    // ... (initTypingEffect sama) ...
    // --- LANYARD PHYSICS ENGINE (FIXED) ---
    const initIdCardPhysics = () => {
        const wrapper = document.getElementById('id-card-wrapper');
        const holder = document.getElementById('id-card');

        if (!wrapper || !holder) return;

        let isDragging = false;
        let dragMoved = false;
        let startX, startY;
        let currentX = 0, currentY = 0;
        let velocityX = 0, velocityY = 0;
        let rotation = 0;
        let angularVelocity = 0;
        let isFlipped = false;

        // Configuration
        const spring = 0.08;
        const friction = 0.85;
        const maxPull = 120;

        // Mouse Down
        wrapper.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragMoved = false;
            startX = e.clientX;
            startY = e.clientY;
            wrapper.style.cursor = 'grabbing';
        });

        // Mouse Move
        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;

            // Deteksi pergerakan untuk flip logic
            if (Math.abs(deltaX) > 3 || Math.abs(deltaY) > 3) {
                dragMoved = true;
            }

            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const scale = distance > maxPull ? maxPull / distance : 1;

            const targetX = deltaX * scale;
            const targetY = Math.max(0, deltaY * scale);

            currentX += (targetX - currentX) * 0.5;
            currentY += (targetY - currentY) * 0.5;

            rotation = currentX * 0.15;
        });

        // Mouse Up
        window.addEventListener('mouseup', () => {
            if (!isDragging) return;
            isDragging = false;
            wrapper.style.cursor = 'grab';
        });

        // Click untuk Flip (hanya jika tidak di-drag)
        wrapper.addEventListener('click', (e) => {
            e.preventDefault();
            if (!dragMoved) { // Hanya flip jika tidak dragging
                isFlipped = !isFlipped;
                console.log('Flip triggered:', isFlipped);
            }
            dragMoved = false;
        });

        // PHYSICS LOOP
        const animate = () => {
            if (!isDragging) {
                const forceX = -currentX * spring;
                const forceY = -currentY * spring;

                velocityX += forceX;
                velocityY += forceY;

                velocityX *= friction;
                velocityY *= friction;

                currentX += velocityX;
                currentY += velocityY;

                const angularForce = -rotation * 0.04;
                angularVelocity += angularForce;
                angularVelocity *= 0.92;
                rotation += angularVelocity;
            } else {
                velocityX = 0;
                velocityY = 0;
                angularVelocity = 0;
            }

            // Transform SELURUH WRAPPER (lanyard + clip + card bergerak bersama)
            wrapper.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rotation}deg)`;

            // Flip logic pada container di dalam holder
            const container = holder.querySelector('.id-card-container');
            if (container) {
                container.style.transform = isFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)';
                container.style.transition = 'transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            }

            requestAnimationFrame(animate);
        };

        animate();
    };

    const initTypingEffect = () => {
        if (!dom.typingEffect) return;
        const words = ["Sutan Arlie Johan", "Web Developer", "IT Enthusiast"];
        let wordIndex = 0, charIndex = 0, isDeleting = false;
        function type() {
            const currentWord = words[wordIndex];
            const typeSpeed = isDeleting ? 75 : 150;
            dom.typingEffect.textContent = currentWord.substring(0, charIndex);
            if (!isDeleting && charIndex < currentWord.length) charIndex++;
            else if (isDeleting && charIndex > 0) charIndex--;
            else { isDeleting = !isDeleting; if (!isDeleting) wordIndex = (wordIndex + 1) % words.length; }
            setTimeout(type, isDeleting || charIndex === currentWord.length ? (isDeleting ? typeSpeed : 2000) : typeSpeed);
        }
        type();
    };

    /* --- LOGIKA MODAL UNIVERSAL (PROJECT + SERTIFIKAT) --- */

    const handleProjectFilter = (e) => {
        if (!e.target.matches('.filter-btn')) return;
        dom.filterBtns.forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        const filter = e.target.dataset.filter;
        dom.projectCards.forEach(card => {
            const category = card.dataset.category;
            card.style.display = (filter === 'all' || category.includes(filter)) ? 'block' : 'none';
        });
    };

    const openUniversalModal = cardElement => {
        if (!dom.projectModal || !dom.modalBody) return;

        const titleText = cardElement.querySelector("h3")?.textContent.trim();
        if (!titleText) return;

        // 1. Coba cari di projectData
        let data = projectData[titleText];
        let type = "project";

        // 2. Kalau tidak ketemu, cek certificateData
        if (!data && certificateData[titleText]) {
            data = certificateData[titleText];
            type = "certificate";
        }

        if (!data) {
            console.error("Data tidak ditemukan untuk:", titleText);
            return;
        }

        let modalHTML = "";

        if (type === "project") {
            // MODAL PROJECT
            modalHTML = `
    <div class="modal-header">
      <h2>${data.title}</h2>
    </div>

    <div class="modal-content">
      <img src="${data.image}" alt="${data.title}" class="modal-image" />
      <p class="modal-description">${data.description}</p>
      <p class="modal-purpose"><strong>Tujuan</strong> ${data.purpose}</p>
      <p class="modal-result"><strong>Hasil</strong> ${data.result}</p>
      <div class="modal-tech">
        <strong>Tech Stack</strong>
        ${data.tech ? data.tech.map(t => `<span class="badge">${t}</span>`).join("") : ""}
      </div>
    </div>
  `;
        }

        else if (type === "certificate") {
            // MODAL SERTIFIKAT FIX
            const imageUrl = data.image || data.fileUrl;
            const fileUrl = data.fileUrl || data.image;

            modalHTML = `
    <div class="modal-header">
      <h2>${data.title}</h2>
      <p class="modal-meta">
        <span><strong>Penyelenggara</strong> ${data.issuer}</span><br>
        <span><strong>Tanggal</strong> ${data.date}</span>
      </p>
    </div>

    <div class="modal-content">
      <p class="modal-description">${data.description}</p>

      <div class="modal-certificate-preview">
        ${data.isPdf
                    ? `<embed src="${fileUrl}" type="application/pdf" class="modal-pdf-preview" />`
                    : `<img src="${imageUrl}" alt="${data.title}" class="modal-image" />`
                }
      </div>

      <div class="modal-actions">
        <a href="${fileUrl}" download class="btn btn-primary">Download Sertifikat</a>
        <a href="${fileUrl}" target="_blank" class="btn btn-outline">Buka di Tab Baru</a>
      </div>
    </div>
  `;
        }

        dom.modalBody.innerHTML = modalHTML;
        dom.projectModal.classList.add("open");
        document.body.classList.add("modal-open");
    };



    const closeProjectModal = () => {
        dom.projectModal.classList.remove('open');
        document.body.classList.remove("modal-open");
        document.body.style.overflow = '';
    };

    const handleModalClick = (e) => {
        if (e.target === dom.projectModal) closeProjectModal();
    };

    // ... (initTestimonialCarousel, initBlog, handleFormSubmit, utilitas throttle sama) ...
    const initTestimonialCarousel = () => {
        if (!dom.testimonialSlides || dom.testimonialSlides.length === 0) return;
        dom.testimonialIndicators.innerHTML = '';
        dom.testimonialSlides.forEach((_, i) => {
            const dot = document.createElement('button');
            dot.classList.add('indicator-dot');
            dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
            if (i === 0) dot.classList.add('active');
            dot.addEventListener('click', () => { goToTestimonialSlide(i); resetTestimonialInterval(); });
            dom.testimonialIndicators.appendChild(dot);
        });
        startTestimonialInterval();
        let touchstartX = 0;
        dom.testimonialCarousel.parentElement.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; clearInterval(state.testimonialInterval); });
        dom.testimonialCarousel.parentElement.addEventListener('touchend', e => {
            const touchendX = e.changedTouches[0].screenX;
            if (touchendX < touchstartX) nextTestimonialSlide();
            if (touchendX > touchstartX) prevTestimonialSlide();
            resetTestimonialInterval();
        });
    };
    const updateTestimonialCarousel = () => {
        dom.testimonialCarousel.style.transform = `translateX(-${state.testimonialCurrentIndex * 100}%)`;
        dom.testimonialIndicators.querySelectorAll('.indicator-dot').forEach((d, i) => d.classList.toggle('active', i === state.testimonialCurrentIndex));
    };
    const nextTestimonialSlide = () => { state.testimonialCurrentIndex = (state.testimonialCurrentIndex + 1) % dom.testimonialSlides.length; updateTestimonialCarousel(); };
    const prevTestimonialSlide = () => { state.testimonialCurrentIndex = (state.testimonialCurrentIndex - 1 + dom.testimonialSlides.length) % dom.testimonialSlides.length; updateTestimonialCarousel(); };
    const goToTestimonialSlide = (index) => { state.testimonialCurrentIndex = index; updateTestimonialCarousel(); };
    const startTestimonialInterval = () => { state.testimonialInterval = setInterval(nextTestimonialSlide, 5000); };
    const resetTestimonialInterval = () => { clearInterval(state.testimonialInterval); startTestimonialInterval(); };

    const initBlog = () => {
        if (!dom.blogPostsContainer || !dom.blogPagination) return;
        const renderBlogPosts = () => {
            dom.blogPostsContainer.innerHTML = '';
            const start = (state.blogCurrentPage - 1) * state.blogPostsPerPage;
            const paginatedPosts = blogPosts.slice(start, start + state.blogPostsPerPage);
            paginatedPosts.forEach(post => {
                const postEl = document.createElement('div');
                postEl.className = 'blog-card animate-on-scroll';
                postEl.innerHTML = `<img src="${post.image}" alt="${post.title}" class="blog-card-image"><div class="blog-card-content"><span class="category">${post.category}</span><h3>${post.title}</h3><p>${post.excerpt}</p><div class="blog-card-footer"><span>${post.date}</span><a href="#" class="read-more">Baca &rarr;</a></div></div>`;
                dom.blogPostsContainer.appendChild(postEl);
            });
            document.querySelectorAll('.blog-card.animate-on-scroll').forEach(el => new IntersectionObserver(e => e[0].isIntersecting && e[0].target.classList.add('is-visible'), { threshold: 0.1 }).observe(el));
        };
        const renderBlogPagination = () => {
            dom.blogPagination.innerHTML = '';
            const totalPages = Math.ceil(blogPosts.length / state.blogPostsPerPage);
            if (totalPages <= 1) return;
            const createBtn = (txt, page, dis, act) => {
                const btn = document.createElement('button');
                btn.innerHTML = txt;
                btn.disabled = dis;
                if (act) btn.classList.add('active');
                btn.addEventListener('click', () => { state.blogCurrentPage = page; renderBlogPosts(); dom.blogPostsContainer.scrollIntoView({ behavior: 'smooth' }); });
                return btn;
            };
            dom.blogPagination.append(createBtn('<', state.blogCurrentPage - 1, state.blogCurrentPage === 1));
            for (let i = 1; i <= totalPages; i++) dom.blogPagination.append(createBtn(i, i, false, state.blogCurrentPage === i));
            dom.blogPagination.append(createBtn('>', state.blogCurrentPage + 1, state.blogCurrentPage === totalPages));
        };
        renderBlogPosts(); renderBlogPagination();
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        if (!validateAllFields()) return;
        const form = e.target; const statusEl = dom.formStatus;
        statusEl.textContent = 'Mengirim...';
        try {
            const response = await fetch(form.action, { method: form.method, body: new FormData(form), headers: { 'Accept': 'application/json' } });
            if (response.ok) { statusEl.textContent = 'Pesan terkirim!'; statusEl.className = 'success'; form.reset(); }
            else { throw new Error('Server error'); }
        } catch (error) { statusEl.textContent = 'Oops! Gagal mengirim.'; statusEl.className = 'error'; }
    };
    const validateField = (field) => {
        const errEl = field.nextElementSibling; let ok = true, msg = '';
        if (field.required && !field.value.trim()) { ok = false; msg = 'Wajib diisi.'; }
        else if (field.type === 'email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(field.value)) { ok = false; msg = 'Email tidak valid.'; }
        else if (field.minLength > 0 && field.value.length < field.minLength) { ok = false; msg = `Minimal ${field.minLength} karakter.`; }
        field.parentElement.classList.toggle('error', !ok);
        if (errEl) errEl.textContent = msg; return ok;
    };
    const validateAllFields = () => Array.from(dom.contactForm.querySelectorAll('input, textarea')).every(f => validateField(f));

    const handleKeyboardInput = (e) => { if (e.key === 'Escape' && dom.projectModal.classList.contains('open')) closeProjectModal(); };
    const updateCopyrightYear = () => { if (dom.copyrightYear) dom.copyrightYear.textContent = new Date().getFullYear(); };
    const throttle = (func, limit) => { let inThrottle; return function (...args) { if (!inThrottle) { func.apply(this, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); } }; };

    init();
});